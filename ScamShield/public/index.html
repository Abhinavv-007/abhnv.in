<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScamShield ‚Äì Infinite Mode</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <!-- Custom Styles and Tailwind Config -->
    <style>
        /* Basic styles and font settings */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom scrollbar for a more modern look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
        }

        /* Enhanced Dark Mode Background */
        .dark body {
            background-color: #0d1117;
        }

        /* Start Page Animated Gradient Background */
        #start-page-wrapper {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        .dark #start-page-wrapper {
            background: linear-gradient(-45deg, #0d1117, #1f2937, #0369a1, #10b981);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Smoother Start Button Glow Effect */
        #start-game-btn {
            animation: pulse-glow 2.5s infinite ease-in-out;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 35px rgba(59, 130, 246, 0.7);
            }
        }

        /* General Animation classes */
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.390, 0.575, 0.565, 1.000) forwards;
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        .slide-in-up {
            animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.95);
            }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal Animation */
        .modal-enter {
            animation: modal-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .modal-leave {
            animation: modal-out 0.3s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }

        @keyframes modal-in {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modal-out {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }

            to {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
        }

        /* Loading spinner animation */
        .loader {
            border: 4px solid #e5e7eb;
            /* Light grey */
            border-top: 4px solid #3b82f6;
            /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .dark .loader {
            border-color: #374151;
            border-top-color: #60a5fa;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0d1117',
                        'dark-card': '#161b22',
                        'dark-border': '#30363d',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-50 dark:bg-dark-bg text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center">

        <!-- Start Page -->
        <div id="start-page-wrapper"
            class="w-full h-screen flex flex-col items-center justify-center p-4 text-center text-white relative">
            <button id="start-settings-btn"
                class="absolute top-6 right-6 p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
            <div id="start-page" class="fade-in">
                <div class="bg-black bg-opacity-20 backdrop-blur-sm p-8 rounded-2xl">
                    <h1 class="text-6xl font-black mb-4">ScamShield</h1>
                    <p class="text-xl text-gray-200 mb-10 max-w-lg mx-auto">Train your instincts. Spot phishing, fraud,
                        and fake messages in a fun, interactive way.</p>
                    <button id="start-game-btn"
                        class="py-4 px-10 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                        Start Game
                    </button>
                </div>
            </div>
            <footer id="start-page-footer"
                class="absolute bottom-6 text-center w-full text-white text-sm opacity-70 fade-in">
                <!-- Footer content will be injected here -->
            </footer>
        </div>

        <!-- Game View (Initially Hidden) -->
        <div id="game-view" class="hidden w-full h-screen flex flex-col items-center p-4">
            <!-- Header Section -->
            <header class="w-full max-w-2xl mx-auto mb-4 flex justify-between items-center flex-shrink-0">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                    ScamShield <span class="text-blue-500">Infinite</span>
                </h1>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <!-- Analyze Message Button -->
                    <button id="analyze-message-btn"
                        class="p-2 rounded-full bg-gray-200 dark:bg-dark-card dark:border dark:border-dark-border hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors text-sm font-semibold flex items-center space-x-2 px-3">
                        <span class="hidden sm:inline">Analyze Message</span>
                        <span class="text-lg">‚ú®</span>
                    </button>
                    <!-- Settings Button -->
                    <button id="game-settings-btn"
                        class="p-2 rounded-full bg-gray-200 dark:bg-dark-card dark:border dark:border-dark-border hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-800 dark:text-gray-200"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button id="darkModeToggle"
                        class="p-2 rounded-full bg-gray-200 dark:bg-dark-card dark:border dark:border-dark-border hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors">
                        <svg id="sunIcon" class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                        <svg id="moonIcon" class="w-5 h-5 text-white hidden" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                            </path>
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main Game Area -->
            <main id="game-container"
                class="w-full max-w-2xl mx-auto bg-white dark:bg-dark-card dark:border dark:border-dark-border rounded-2xl shadow-lg p-6 transition-all duration-300 flex-grow">

                <!-- XP and Progress Bar -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-semibold text-blue-600 dark:text-blue-400">Level <span
                                id="level">1</span></span>
                        <span class="text-sm font-bold"><span id="xp">0</span> XP</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="xp-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500"
                            style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Daily Streak: <span
                                id="streak" class="font-bold">0</span> üî•</span>
                    </div>
                </div>

                <!-- Message Display Area -->
                <div id="message-wrapper" class="relative min-h-[350px]">
                    <!-- Loading State -->
                    <div id="loader-view" class="absolute inset-0 flex flex-col items-center justify-center">
                        <div class="loader"></div>
                        <p class="mt-4 text-gray-500 dark:text-gray-400 font-medium">Analyzing new threats...</p>
                    </div>

                    <!-- Message Card -->
                    <div id="message-card" class="hidden">
                        <div
                            class="flex items-center space-x-3 mb-4 pb-4 border-b border-gray-200 dark:border-dark-border">
                            <div id="message-icon"
                                class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                            </div>
                            <div class="flex-1">
                                <p id="message-sender" class="font-bold text-gray-900 dark:text-white"></p>
                                <p id="message-subject" class="text-sm text-gray-500 dark:text-gray-400"></p>
                            </div>
                        </div>
                        <div id="message-body"
                            class="prose prose-sm dark:prose-invert max-w-none h-48 overflow-y-auto custom-scrollbar whitespace-pre-wrap">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="scam-button"
                        class="w-full py-3 px-4 rounded-xl bg-red-500 hover:bg-red-600 text-white font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">Scam</button>
                    <button id="safe-button"
                        class="w-full py-3 px-4 rounded-xl bg-green-500 hover:bg-green-600 text-white font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-100 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">Safe</button>
                </div>

                <div id="next-button-container" class="mt-6 hidden">
                    <button id="next-button"
                        class="w-full py-3 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-100">Next
                        Message</button>
                </div>
            </main>
            <footer id="game-page-footer" class="w-full max-w-2xl mx-auto py-4 text-center flex-shrink-0">
                <!-- Footer content will be injected here -->
            </footer>
        </div>

        <!-- Result Overlay -->
        <div id="result-overlay"
            class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
            <div id="result-card"
                class="bg-white dark:bg-dark-card dark:border dark:border-dark-border rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <div id="result-icon" class="mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4">
                </div>
                <h2 id="result-title" class="text-3xl font-black mb-2"></h2>
                <p id="result-explanation" class="text-gray-600 dark:text-gray-300 mb-6 min-h-[60px]"></p>
                <div id="result-explanation-loader" class="hidden min-h-[60px] flex justify-center items-center mb-6">
                    <div class="loader"></div>
                </div>
                <div class="space-y-3">
                    <button id="simple-explanation-btn"
                        class="hidden w-full py-3 px-4 rounded-xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold transition-all duration-200 transform hover:scale-105 active:scale-100">‚ú®
                        Explain It Simply</button>
                    <button id="result-next-button"
                        class="w-full py-3 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-bold text-lg transition-all duration-200 transform hover:scale-105 active:scale-100">Continue</button>
                </div>
            </div>
        </div>

        <!-- Analyze Message Modal -->
        <div id="analyze-modal"
            class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
            <div id="analyze-modal-content"
                class="bg-white dark:bg-dark-card dark:border dark:border-dark-border rounded-2xl shadow-2xl p-6 max-w-lg w-full max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-xl font-bold">‚ú® Analyze a Message</h3>
                    <button id="close-analyze-modal-btn"
                        class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
                </div>
                <div class="overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Paste any suspicious Email, SMS, or message
                        below and our AI will analyze it for signs of a scam.</p>
                    <textarea id="analyze-textarea"
                        class="w-full h-40 p-3 rounded-lg border bg-gray-50 dark:bg-dark-bg dark:border-dark-border focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        placeholder="Paste message text here..."></textarea>
                    <div id="analyze-result-container" class="mt-4 hidden">
                        <h4 class="font-bold mb-2 text-left">Analysis Result:</h4>
                        <div id="analyze-result-text"
                            class="prose prose-sm dark:prose-invert max-w-none p-3 bg-gray-100 dark:bg-dark-bg rounded-lg text-left">
                        </div>
                    </div>
                    <div id="analyze-loader" class="hidden mt-4 flex justify-center items-center">
                        <div class="loader"></div>
                    </div>
                </div>
                <button id="submit-analyze-btn"
                    class="mt-4 w-full py-3 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-bold transition-all duration-200 transform hover:scale-105 active:scale-100 flex-shrink-0">Analyze
                    Now</button>
            </div>
        </div>

        <!-- Settings / API Key Modal -->
        <div id="settings-modal"
            class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
            <div id="settings-modal-content"
                class="bg-white dark:bg-dark-card dark:border dark:border-dark-border rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                <h2 class="text-2xl font-bold mb-4">Settings</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-6 text-sm">Enter your Gemini API Key to enable AI
                    features. Your key is stored locally in your browser and is never sent to our servers.</p>

                <div class="mb-6 text-left">
                    <label class="block text-sm font-bold mb-2 text-gray-700 dark:text-gray-300">Google Gemini API
                        Key</label>
                    <div class="relative">
                        <input type="password" id="api-key-input"
                            class="w-full p-3 pr-10 rounded-lg border bg-gray-50 dark:bg-dark-bg dark:border-dark-border focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            placeholder="AIwaSy..." />
                        <button id="toggle-key-visibility"
                            class="absolute right-3 top-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank"
                        class="text-xs text-blue-500 hover:underline mt-2 inline-block">Get a free API key here
                        &rarr;</a>
                </div>

                <div class="space-y-3">
                    <button id="save-settings-btn"
                        class="w-full py-3 px-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all duration-200 transform hover:scale-105 active:scale-100">Save
                        & Continue</button>
                    <button id="close-settings-btn"
                        class="w-full py-3 px-4 rounded-xl text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const app = {
                // Views
                startPageWrapper: document.getElementById('start-page-wrapper'),
                startPage: document.getElementById('start-page'),
                gameView: document.getElementById('game-view'),
                startGameBtn: document.getElementById('start-game-btn'),
                startPageFooter: document.getElementById('start-page-footer'),
                gamePageFooter: document.getElementById('game-page-footer'),

                // Main containers
                gameContainer: document.getElementById('game-container'),
                messageWrapper: document.getElementById('message-wrapper'),
                loaderView: document.getElementById('loader-view'),
                messageCard: document.getElementById('message-card'),

                // Message content
                messageIcon: document.getElementById('message-icon'),
                messageSender: document.getElementById('message-sender'),
                messageSubject: document.getElementById('message-subject'),
                messageBody: document.getElementById('message-body'),

                // Buttons
                scamButton: document.getElementById('scam-button'),
                safeButton: document.getElementById('safe-button'),
                actionButtons: document.getElementById('action-buttons'),
                nextButtonContainer: document.getElementById('next-button-container'),
                nextButton: document.getElementById('next-button'),

                // XP and Stats
                xpDisplay: document.getElementById('xp'),
                xpBar: document.getElementById('xp-bar'),
                levelDisplay: document.getElementById('level'),
                streakDisplay: document.getElementById('streak'),

                // Result Overlay
                resultOverlay: document.getElementById('result-overlay'),
                resultCard: document.getElementById('result-card'),
                resultIcon: document.getElementById('result-icon'),
                resultTitle: document.getElementById('result-title'),
                resultExplanation: document.getElementById('result-explanation'),
                resultExplanationLoader: document.getElementById('result-explanation-loader'),
                simpleExplanationBtn: document.getElementById('simple-explanation-btn'),
                resultNextButton: document.getElementById('result-next-button'),

                // Analyze Modal
                analyzeMessageBtn: document.getElementById('analyze-message-btn'),
                analyzeModal: document.getElementById('analyze-modal'),
                analyzeModalContent: document.getElementById('analyze-modal-content'),
                closeAnalyzeModalBtn: document.getElementById('close-analyze-modal-btn'),
                analyzeTextarea: document.getElementById('analyze-textarea'),
                submitAnalyzeBtn: document.getElementById('submit-analyze-btn'),
                analyzeResultContainer: document.getElementById('analyze-result-container'),
                analyzeResultText: document.getElementById('analyze-result-text'),
                analyzeLoader: document.getElementById('analyze-loader'),

                // Dark Mode
                darkModeToggle: document.getElementById('darkModeToggle'),
                sunIcon: document.getElementById('sunIcon'),
                moonIcon: document.getElementById('moonIcon'),

                // Settings Modal
                startSettingsBtn: document.getElementById('start-settings-btn'),
                gameSettingsBtn: document.getElementById('game-settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                settingsModalContent: document.getElementById('settings-modal-content'),
                apiKeyInput: document.getElementById('api-key-input'),
                toggleKeyVisibilityBtn: document.getElementById('toggle-key-visibility'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
            };

            // --- GAME STATE ---
            let state = {
                xp: 0,
                streak: 0,
                lastPlayed: null,
                messages: [],
                currentMessageIndex: 0,
                isFetching: false,
                isDarkMode: false,
                apiKey: '',
            };

            const XP_PER_LEVEL = 100;

            // --- INITIALIZATION ---
            function init() {
                loadState();
                updateUI();
                renderFooters();

                app.startSettingsBtn.addEventListener('click', () => openSettingsModal(true));
                app.gameSettingsBtn.addEventListener('click', () => openSettingsModal(false));
                app.saveSettingsBtn.addEventListener('click', saveSettings);
                app.closeSettingsBtn.addEventListener('click', closeSettingsModal);
                app.toggleKeyVisibilityBtn.addEventListener('click', toggleKeyVisibility);

                app.startGameBtn.addEventListener('click', startGame);
                app.scamButton.addEventListener('click', () => handleAnswer(true));
                app.safeButton.addEventListener('click', () => handleAnswer(false));
                app.nextButton.addEventListener('click', showNextMessage);
                app.resultNextButton.addEventListener('click', showNextMessage);
                app.darkModeToggle.addEventListener('click', toggleDarkMode);
                app.simpleExplanationBtn.addEventListener('click', fetchSimpleExplanation);
                app.analyzeMessageBtn.addEventListener('click', openAnalyzeModal);
                app.closeAnalyzeModalBtn.addEventListener('click', closeAnalyzeModal);
                app.submitAnalyzeBtn.addEventListener('click', handleAnalyzeSubmit);
            }

            function startGame() {
                if (!state.apiKey) {
                    openSettingsModal(true);
                    return;
                }

                app.startPageWrapper.classList.add('fade-out');
                setTimeout(() => {
                    app.startPageWrapper.classList.add('hidden');
                    app.gameView.classList.remove('hidden');
                    app.gameView.classList.add('fade-in');

                    if (state.messages.length === 0 || state.currentMessageIndex >= state.messages.length) {
                        fetchMessages();
                    } else {
                        renderCurrentMessage();
                    }
                }, 500); // Match animation duration
            }

            function renderFooters() {
                const footerHTML = `
                <div class="flex flex-col items-center space-y-2">
                    <p class="text-sm text-gray-500 dark:text-gray-400">Made with ‚ù§Ô∏è by Abhinav</p>
                    <a href="https://www.linkedin.com/in/abhinavv007/" target="_blank" rel="noopener noreferrer" 
                       class="inline-flex items-center space-x-2 px-4 py-2 rounded-full bg-white/10 dark:bg-white/10 backdrop-blur-sm text-white dark:text-gray-200 hover:bg-white/20 dark:hover:bg-white/20 transition-all duration-300 shadow-lg">
                        <svg class="w-5 h-5" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"/></svg>
                        <span>LinkedIn Profile</span>
                    </a>
                </div>
            `;
                const gameFooterHTML = `
                 <div class="flex flex-col items-center space-y-2 opacity-60 hover:opacity-100 transition-opacity">
                    <p class="text-xs text-gray-500 dark:text-gray-400">Made with ‚ù§Ô∏è by Abhinav</p>
                    <a href="https://www.linkedin.com/in/abhinavv007/" target="_blank" rel="noopener noreferrer" 
                       class="inline-flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors">
                        <svg class="w-4 h-4" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z"/></svg>
                        <span>LinkedIn Profile</span>
                    </a>
                </div>
            `;
                app.startPageFooter.innerHTML = footerHTML;
                app.gamePageFooter.innerHTML = gameFooterHTML;
            }

            // --- STATE MANAGEMENT (localStorage) ---
            function loadState() {
                const savedState = localStorage.getItem('scamShieldState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    state = { ...state, ...parsedState };
                }
                // Ensure apiKey is loaded separately or persists correctly
                const savedKey = localStorage.getItem('scamShield_apiKey');
                if (savedKey) state.apiKey = savedKey;

                if (localStorage.getItem('darkMode') === 'true') {
                    state.isDarkMode = true;
                    document.documentElement.classList.add('dark');
                }
                checkStreak();
            }

            function saveState() {
                const stateToSave = { ...state };
                delete stateToSave.apiKey; // Don't save key in game state dump
                localStorage.setItem('scamShieldState', JSON.stringify(stateToSave));
                localStorage.setItem('darkMode', state.isDarkMode);
                localStorage.setItem('scamShield_apiKey', state.apiKey);
            }

            function checkStreak() {
                if (!state.lastPlayed) return;
                const lastDate = new Date(state.lastPlayed);
                const today = new Date();
                const diffTime = today - lastDate;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                if (diffDays > 2) {
                    state.streak = 0;
                }
            }

            // --- UI UPDATES ---
            function updateUI() {
                const level = Math.floor(state.xp / XP_PER_LEVEL) + 1;
                const xpInLevel = state.xp % XP_PER_LEVEL;
                app.xpDisplay.textContent = state.xp;
                app.levelDisplay.textContent = level;
                app.xpBar.style.width = `${(xpInLevel / XP_PER_LEVEL) * 100}%`;
                app.streakDisplay.textContent = state.streak;
                if (state.isDarkMode) {
                    app.sunIcon.classList.add('hidden');
                    app.moonIcon.classList.remove('hidden');
                } else {
                    app.sunIcon.classList.remove('hidden');
                    app.moonIcon.classList.add('hidden');
                }
            }

            function toggleLoading(isLoading) {
                state.isFetching = isLoading;
                if (isLoading) {
                    app.loaderView.classList.remove('hidden');
                    app.messageCard.classList.add('hidden');
                    app.actionButtons.classList.add('hidden');
                    app.nextButtonContainer.classList.add('hidden');
                } else {
                    app.loaderView.classList.add('hidden');
                    app.messageCard.classList.remove('hidden');
                    app.actionButtons.classList.remove('hidden');
                    app.messageCard.classList.add('slide-in-up');
                }
            }

            // --- MODAL & SETTINGS LOGIC ---
            function openSettingsModal(fromStartPage = false) {
                app.settingsModal.classList.remove('hidden');
                app.settingsModalContent.classList.remove('modal-leave');
                app.settingsModalContent.classList.add('modal-enter');
                app.apiKeyInput.value = state.apiKey;

                // If opening from start page and no key, maybe force them?
                // For now just standard open.
            }

            function closeSettingsModal() {
                app.settingsModalContent.classList.remove('modal-enter');
                app.settingsModalContent.classList.add('modal-leave');
                setTimeout(() => {
                    app.settingsModal.classList.add('hidden');
                }, 300);
            }

            function saveSettings() {
                const key = app.apiKeyInput.value.trim();
                if (!key) {
                    alert("Please enter a valid API Key.");
                    return;
                }
                state.apiKey = key;
                saveState();
                closeSettingsModal();

                // If we are on the hidden game view (meaning we forced open modal to start), we might want to auto start?
                // Actually startGame handles the check. If the user was stuck on start screen:
                if (!app.startPageWrapper.classList.contains('hidden')) {
                    // optional: automatically trigger start game if they clicked save from start page context?
                    // simpler to just let them click Start Game again.
                } else {
                    // if they changed key mid-game, maybe clear messages to force refresh?
                    // state.messages = [];
                }
            }

            function toggleKeyVisibility() {
                if (app.apiKeyInput.type === 'password') {
                    app.apiKeyInput.type = 'text';
                } else {
                    app.apiKeyInput.type = 'password';
                }
            }

            // --- GEMINI API ---
            async function callGemini(prompt) {
                if (!state.apiKey) {
                    openSettingsModal();
                    return "Please enter your API Key in Settings to continue.";
                }

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    if (!response.ok) {
                        if (response.status === 400 || response.status === 403) {
                            alert("Invalid API Key. Please check your settings.");
                            openSettingsModal();
                            throw new Error("Invalid API Key");
                        }
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                    const result = await response.json();
                    return result.candidates[0].content.parts[0].text;
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    if (error.message === "Invalid API Key") return "Invalid API Key.";
                    return "Sorry, I couldn't connect to the AI analysis service right now. Please try again later.";
                }
            }

            async function fetchMessages() {
                if (state.isFetching) return;
                toggleLoading(true);

                const prompt = `
                You are a scam message generator for a cybersecurity training game called "ScamShield".
                Generate a JSON array of 7 unique messages.
                - 2-3 messages must be legitimate.
                - The rest must be scams (phishing, fake jobs, romance, urgent payment, tech support).
                - Randomize the order.
                - For each message, provide a concise, one-sentence explanation for why it is a scam or legitimate.
                - Content should be realistic with line breaks (\\n). Senders and subjects should be realistic.
                - For higher player levels (e.g., Level 5+), create more subtle and sophisticated scams that are harder to spot.

                Return ONLY the raw JSON array, no other text or markdown. Structure:
                [
                  {"type": "Email" | "SMS" | "DM" | "Call", "sender": "...", "subject": "...", "message": "...", "isScam": boolean, "explanation": "..."}
                ]
            `;

                const rawResponse = await callGemini(prompt);
                try {
                    const cleanedText = rawResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newMessages = JSON.parse(cleanedText);
                    state.messages = newMessages;
                    state.currentMessageIndex = 0;
                    saveState();
                    renderCurrentMessage();
                } catch (error) {
                    console.error("Failed to parse messages:", error, "Raw response:", rawResponse);
                    state.messages = getFallbackMessages();
                    state.currentMessageIndex = 0;
                    renderCurrentMessage();
                } finally {
                    toggleLoading(false);
                }
            }

            async function fetchSimpleExplanation() {
                const msg = state.messages[state.currentMessageIndex];
                app.resultExplanation.classList.add('hidden');
                app.resultExplanationLoader.classList.remove('hidden');
                app.simpleExplanationBtn.disabled = true;

                const prompt = `
                Explain the following situation to me like I'm 5 years old. Use a simple analogy.
                The user was shown this message:
                ---
                ${msg.message}
                ---
                The correct analysis is: "${msg.explanation}"
                
                Your explanation should be very simple, friendly, and start with something like "Imagine..." or "It's like...". Keep it to 2-3 sentences.
            `;

                const simpleExplanation = await callGemini(prompt);
                app.resultExplanation.textContent = simpleExplanation;
                app.resultExplanation.classList.remove('hidden');
                app.resultExplanationLoader.classList.add('hidden');
                app.simpleExplanationBtn.classList.add('hidden');
            }

            function openAnalyzeModal() {
                app.analyzeModal.classList.remove('hidden');
                app.analyzeModalContent.classList.remove('modal-leave');
                app.analyzeModalContent.classList.add('modal-enter');
            }

            function closeAnalyzeModal() {
                app.analyzeModalContent.classList.remove('modal-enter');
                app.analyzeModalContent.classList.add('modal-leave');
                setTimeout(() => {
                    app.analyzeModal.classList.add('hidden');
                    app.analyzeTextarea.value = '';
                    app.analyzeResultContainer.classList.add('hidden');
                    app.submitAnalyzeBtn.disabled = false;
                }, 300);
            }

            async function handleAnalyzeSubmit() {
                const textToAnalyze = app.analyzeTextarea.value;
                if (!textToAnalyze.trim()) {
                    app.analyzeResultText.textContent = "Please paste a message to analyze.";
                    app.analyzeResultContainer.classList.remove('hidden');
                    return;
                }

                app.analyzeLoader.classList.remove('hidden');
                app.submitAnalyzeBtn.disabled = true;
                app.analyzeResultContainer.classList.add('hidden');

                const prompt = `
                Act as a cybersecurity expert. Analyze the following message for signs of a scam.
                Provide a verdict (Likely Scam, Likely Safe, or Unsure) and a brief, bulleted list of the key reasons for your verdict.
                Be concise and clear. Use markdown for bolding (**text**) and bullet points (* text).
                
                Message to analyze:
                ---
                ${textToAnalyze}
                ---
            `;

                const analysis = await callGemini(prompt);

                const formattedAnalysis = analysis
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^\* (.*$)/gm, '<p class="pl-4 -indent-4">‚Ä¢ $1</p>')
                    .replace(/\n/g, '<br>')
                    .replace(/<br>‚Ä¢/g, '‚Ä¢');

                app.analyzeResultText.innerHTML = formattedAnalysis;
                app.analyzeLoader.classList.add('hidden');
                app.analyzeResultContainer.classList.remove('hidden');
                app.submitAnalyzeBtn.disabled = false;
            }

            // --- GAME LOGIC ---
            function renderCurrentMessage() {
                if (state.currentMessageIndex >= state.messages.length) {
                    fetchMessages();
                    return;
                }
                const msg = state.messages[state.currentMessageIndex];
                const icons = {
                    Email: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>`,
                    SMS: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`,
                    DM: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
                    Call: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>`
                };
                app.messageIcon.innerHTML = icons[msg.type] || icons['Email'];
                app.messageSender.textContent = msg.sender;
                app.messageSubject.textContent = msg.subject || `New ${msg.type}`;
                app.messageBody.textContent = msg.message;
                app.scamButton.disabled = false;
                app.safeButton.disabled = false;
                app.actionButtons.classList.remove('hidden');
                app.nextButtonContainer.classList.add('hidden');
                app.resultOverlay.classList.add('hidden');
            }

            function handleAnswer(isScamGuess) {
                const msg = state.messages[state.currentMessageIndex];
                const isCorrect = (isScamGuess === msg.isScam);
                app.scamButton.disabled = true;
                app.safeButton.disabled = true;

                if (isCorrect) {
                    state.xp += 10;
                    updateStreak();
                    showResult(true, "Correct!", msg.explanation);
                } else {
                    state.xp = Math.max(0, state.xp - 5);
                    state.streak = 0;
                    showResult(false, "Incorrect!", msg.explanation);
                }
                state.lastPlayed = new Date().toISOString();
                updateUI();
                saveState();
            }

            function updateStreak() {
                if (!state.lastPlayed) {
                    state.streak = 1;
                    return;
                }
                const lastDate = new Date(state.lastPlayed);
                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);
                const isSameDay = lastDate.toDateString() === today.toDateString();
                const isConsecutiveDay = lastDate.toDateString() === yesterday.toDateString();

                if (isConsecutiveDay) state.streak++;
                else if (!isSameDay) state.streak = 1;
            }

            function showResult(isCorrect, title, explanation) {
                app.resultTitle.textContent = title;
                app.resultExplanation.textContent = explanation;
                app.resultExplanation.classList.remove('hidden');
                app.resultExplanationLoader.classList.add('hidden');
                app.simpleExplanationBtn.classList.add('hidden');
                app.simpleExplanationBtn.disabled = false;

                if (isCorrect) {
                    app.resultIcon.innerHTML = `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    app.resultIcon.className = 'mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-green-500';
                    app.resultTitle.className = 'text-3xl font-black mb-2 text-green-500 dark:text-green-400';
                } else {
                    app.resultIcon.innerHTML = `<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                    app.resultIcon.className = 'mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-red-500';
                    app.resultTitle.className = 'text-3xl font-black mb-2 text-red-500 dark:text-red-400';
                    app.simpleExplanationBtn.classList.remove('hidden');
                }

                app.resultOverlay.classList.remove('hidden');
                app.resultCard.classList.remove('modal-leave');
                app.resultCard.classList.add('modal-enter');
                app.actionButtons.classList.add('hidden');
                app.nextButtonContainer.classList.remove('hidden');
            }

            function showNextMessage() {
                app.resultCard.classList.remove('modal-enter');
                app.resultCard.classList.add('modal-leave');
                setTimeout(() => {
                    app.resultOverlay.classList.add('hidden');
                }, 300);

                app.messageCard.classList.remove('slide-in-up');
                app.messageCard.classList.add('fade-out');

                setTimeout(() => {
                    state.currentMessageIndex++;
                    if (state.currentMessageIndex >= state.messages.length) {
                        fetchMessages();
                    } else {
                        renderCurrentMessage();
                        app.messageCard.classList.remove('fade-out');
                        app.messageCard.classList.add('fade-in');
                    }
                    saveState();
                }, 500);
            }

            function toggleDarkMode() {
                state.isDarkMode = !state.isDarkMode;
                document.documentElement.classList.toggle('dark');
                updateUI();
                saveState();
            }

            function getFallbackMessages() {
                return [
                    { "type": "Email", "sender": "support@yourbank-login.com", "subject": "Urgent: Your Account is Suspended", "message": "Dear customer,\n\nWe have detected suspicious activity on your account. To protect your funds, we have temporarily suspended it.\n\nPlease verify your identity immediately by clicking here: http://yourbank-login.co/verify\n\nFailure to do so within 24 hours will result in permanent account closure.", "isScam": true, "explanation": "This is a scam because it uses an urgent tone and a suspicious link that doesn't match a real bank's domain." },
                    { "type": "SMS", "sender": "+1 (555) 123-4567", "subject": "", "message": "Hey, it's Sarah from the party last night! Was great meeting you. Here's that pic we took: [link-to-malware].xyz/photo.jpg", "isScam": true, "explanation": "This is a scam because unsolicited messages from unknown numbers with strange links are often attempts to install malware." },
                    { "type": "Email", "sender": "no-reply@realcompany.com", "subject": "Your password has been reset", "message": "Hello,\n\nThis is a confirmation that the password for your account has just been changed.\n\nIf you did not make this change, please contact our support team immediately.\n\nThanks,\nThe RealCompany Team", "isScam": false, "explanation": "This is a legitimate security notification from a trusted sender with no suspicious links or urgent demands." }
                ];
            }

            init();
        });
    </script>

</body>

</html>